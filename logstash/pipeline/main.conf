input {
  file {
    path => "/data/log/a-mule.log"
    start_position => "beginning"
    type => "smile"
    codec => multiline {
      pattern => "^%{LOGLEVEL}+%{SPACE}%{TIMESTAMP_ISO8601}"
      negate => true
      what => "previous"
    }
  }
}

filter {
  grok {
    match => { "message" => "%{LOGLEVEL:lv}+%{SPACE}%{TIMESTAMP_ISO8601:ts} %{GREEDYDATA:wk}\.worker\.%{DATA:id}] %{NOTSPACE:app}: ((\n%{DATA:key} ('(?<mtd>\\.|[^\\']+)+')%{GREEDYDATA})((\s:\s%{GREEDYDATA:url})|(\s->\s%{GREEDYDATA:js}))|(==+ %{DATA:proc} %{GREEDYDATA}==+)|((%{DATA:key} (Object|%{DATA:mtd})|%{DATA:key})\s:\s%{GREEDYDATA:js})|(%{GREEDYDATA:obj}))" }
  }
  date {
    match => [ "ts", "ISO8601" ]
    timezone => "Asia/Jakarta"
    remove_field => [ "ts" ]
  }
  if [key] == 'REQUEST' or [key] == 'RESPONSE' {
    # mutate {
    #     remove_field => [ "js" ]
    # }
    drop {}
  } else if [key] == 'Response' {
    if [mtd] == 'Akhir' {
      json {
        source => "js"
      }
      
    }
    else if [mtd] == 'GET' {
      json {
        source => "js"
      }
      if [Result] {
        mutate {
          add_field => { "debug" => "Result true" }
          #   "info" => "%{Data[additionalData]}"
          # }
          # remove_field => [ "[Data][Time]", "Data[Date]",  "%{Data[DE44]}", "%{[Data][TraceNum]}" ]
          remove_field => [ "[Data][Time]", "[Data][Date]",  "[Data][DE44]", "[Data][DE37]", "[Data][DE48][DestName]", "[Data][DE48][AmountList]", "[Data][DE48][CurrencyCode]" ]
        }
      } else {
        mutate {
          add_field => { "debug" => "Result false" }
          remove_field => [ "cfcif#", "kode_akses", "SCCODE", "actype", "CFINSC", "DDCTYP", "typecard", "cfbir6", "cfsnme", "source", "cfssno", "mom_name", "sts", "branch_cif" ]
        }
      }
    }
    else if [mtd] == 'POST' {

    }
    
  } else if [key] == 'Json' {
    json {
        source => "js"
        remove_field => [ "amount", "berita", "DeviceInfo", "Latlon", "SimInfo" ]
    }
  }
}

output {
  stdout { codec => rubydebug }
  elasticsearch {
    hosts => [ "https://192.168.1.246:9200", "https://192.168.1.247:9200", "https://192.168.1.248:9200" ]
    user => "${ELASTIC_USERNAME}"
    password => "${ELASTIC_PASSWORD}"
    index => "a-mule-01"
    ssl => true
    cacert => '/certs/ca/ca.crt'
  }
}